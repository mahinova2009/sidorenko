<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #E5E5E5;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }

  .form-container {
    background-color: #FFFFFF;
    border-radius: 12px;
    padding: 30px 40px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 400px;
  }

  h3 {
    text-align: center;
    color: #0088CC;
    margin-bottom: 15px;
  }

  label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #333333;
  }

  input[type="text"],
  input[type="email"],
  input[type="tel"],
  input[type="date"],
  input[type="search"] {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #CCCCCC;
    border-radius: 8px;
    font-size: 15px;
    margin-bottom: 12px;
    box-sizing: border-box;
    transition: border-color 0.2s;
  }

  input:focus {
    outline: none;
    border-color: #0088CC;
    box-shadow: 0 0 4px rgba(0,136,204,0.3);
  }

  .country-wrapper {
    position: relative;
    width: 100%;
  }

  .country-list {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    max-height: 180px;
    overflow-y: auto;
    border-radius: 6px;
    z-index: 1000;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    display: none;
  }

  .country-list div {
    padding: 8px;
    cursor: pointer;
  }

  .country-list div:hover {
    background: #f0f0f0;
  }

  .consent {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }

  .consent input {
    margin-right: 8px;
  }

  button[type="submit"] {
    width: 100%;
    padding: 12px 0;
    background-color: #0088CC;
    color: #FFFFFF;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s;
  }

  button[type="submit"]:hover {
    background-color: #006699;
  }

  .message {
    text-align: center;
    margin-top: 10px;
    font-weight: bold;
  }

  .message.success { color: #008800; }
  .message.error { color: #CC0000; }
</style>
</head>
<body>

<div class="form-container">
  <h3 id="formTitle">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>

  <form id="registrationForm">
    <label for="countrySearch">–°—Ç—Ä–∞–Ω–∞</label>
    <div class="country-wrapper">
      <input type="search" id="countrySearch" placeholder="–ü–æ–∏—Å–∫ —Å—Ç—Ä–∞–Ω—ã..." autocomplete="off">
      <div id="countryList" class="country-list"></div>
    </div>

    <label for="phoneInput">–¢–µ–ª–µ—Ñ–æ–Ω</label>
    <input type="tel" id="phoneInput" name="phone" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">

    <label for="fullNameInput">–§–ò–û</label>
    <input type="text" id="fullNameInput" name="fullName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û">

    <label for="emailInput">Email</label>
    <input type="email" id="emailInput" name="email" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Email">

    <label for="birthDateInput">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
    <input id="birthDateInput" name="birthDate" type="date">
    <small>–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –≤–∞—à–µ–≥–æ —Ä–æ–∂–¥–µ–Ω–∏—è (–Ω–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É)</small>

    <div class="consent">
      <input type="checkbox" id="consentCheck">
      <label for="consentCheck">–Ø —Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</label>
    </div>

    <input type="hidden" name="country" id="countryHidden">
    <input type="hidden" name="timezone" id="timezoneHidden">
    <input type="hidden" name="chat_id" id="chat_id">

    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <div id="formMessage" class="message"></div>
  </form>
</div>

<script>
const webhookUrl = "https://hook.eu2.make.com/1unspxkdfik4bgnhsvpra9m71urdffcj";
const sheetUrl = "https://docs.google.com/spreadsheets/d/1mgEwwfnPwDtYOwob522Xh--A18QcqHrrCon3DWHL25w/gviz/tq?tqx=out:json";

const form = document.getElementById("registrationForm");
const formMessage = document.getElementById("formMessage");
const chatIdField = document.getElementById("chat_id");
const urlParams = new URLSearchParams(window.location.search);
chatIdField.value = urlParams.get("chat_id") || "";

const countryHidden = document.getElementById("countryHidden");
const timezoneHidden = document.getElementById("timezoneHidden");
const searchInput = document.getElementById("countrySearch");
const countryListDiv = document.getElementById("countryList");
const phoneInput = document.getElementById("phoneInput");

const countries = [
  { name: ["–ú–æ–ª–¥–æ–≤–∞","Moldova"], code: "+373", offset: "+0" },
  { name: ["–†–æ—Å—Å–∏—è","Russia","–ú–æ—Å–∫–≤–∞","Moscow"], code: "+7", offset: "+1" },
  { name: ["–£–∫—Ä–∞–∏–Ω–∞","Ukraine","–ö–∏–µ–≤","Kyiv"], code: "+380", offset: "+0" },
  { name: ["–ë–µ–ª–∞—Ä—É—Å—å","Belarus"], code: "+375", offset: "+1" },
  { name: ["–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω","Kazakhstan"], code: "+7", offset: "+4" },
  { name: ["–¢—É—Ä—Ü–∏—è","Turkey"], code: "+90", offset: "+1" },
  { name: ["–ì—Ä–µ—Ü–∏—è","Greece"], code: "+30", offset: "+0" },
  { name: ["–û–ê–≠","UAE","Dubai"], code: "+971", offset: "+2" },
  { name: ["–°–®–ê","USA","United States"], code: "+1", offset: "-7" }
];

searchInput.addEventListener("input", () => {
  const query = searchInput.value.toLowerCase();
  countryListDiv.innerHTML = "";
  if (query.length > 0) {
    const filtered = countries.filter(c => c.name.some(n => n.toLowerCase().includes(query)));
    filtered.forEach(c => {
      const div = document.createElement("div");
      div.textContent = `${c.name[0]} (UTC${c.offset})`;
      div.addEventListener("click", () => {
        searchInput.value = c.name[0];
        countryHidden.value = c.name[0];
        phoneInput.value = c.code;
        timezoneHidden.value = c.offset;
        countryListDiv.style.display = "none";
      });
      countryListDiv.appendChild(div);
    });
    countryListDiv.style.display = filtered.length ? "block" : "none";
  } else {
    countryListDiv.style.display = "none";
  }
});

// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets
async function loadSheetData() {
  try {
    const res = await fetch(sheetUrl);
    const text = await res.text();
    const json = JSON.parse(text.substring(47, text.length - 2));
    return json.table.rows.map(r => ({
      fullName: (r.c[0]?.v || "").trim().toLowerCase(),
      email: (r.c[1]?.v || "").trim(),
      phone: (r.c[2]?.v || "").trim(),
      birthDate: (r.c[3]?.v || "").trim(),
      country: (r.c[4]?.v || "").trim(),
      timezone: (r.c[5]?.v || "").trim(),
      chat_id: (r.c[6]?.v || "").trim()
    }));
  } catch (e) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã:", e);
    return [];
  }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  formMessage.textContent = "";
  formMessage.className = "message";

  if (!document.getElementById("consentCheck").checked) {
    formMessage.textContent = "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ.";
    formMessage.classList.add("error");
    return;
  }

  const data = {
    fullName: form.fullName.value.trim(),
    email: form.email.value.trim(),
    phone: form.phone.value.trim(),
    birthDate: form.birthDate.value.trim(),
    country: countryHidden.value,
    timezone: timezoneHidden.value,
    chat_id: chatIdField.value
  };

  if (!data.fullName || !data.email || !data.phone || !data.birthDate || !data.country) {
    formMessage.textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.";
    formMessage.classList.add("error");
    return;
  }

  const users = await loadSheetData();
  const found = users.find(u =>
    u.fullName === data.fullName.toLowerCase() &&
    u.birthDate === data.birthDate
  );

  if (found) {
    if (found.chat_id) {
      formMessage.textContent = "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã ‚úÖ";
      formMessage.classList.add("success");
      return;
    } else {
      await fetch(webhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      formMessage.textContent = "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üéâ –í–∞—à chat_id –¥–æ–±–∞–≤–ª–µ–Ω.";
      formMessage.classList.add("success");
      return;
    }
  }

  const response = await fetch(webhookUrl, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });

  if (response.ok) {
    formMessage.textContent = "–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã! ‚úÖ";
    formMessage.classList.add("success");
    form.reset();
  } else {
    formMessage.textContent = `–û—à–∏–±–∫–∞: ${response.status}`;
    formMessage.classList.add("error");
  }
});
</script>

</body>
</html>
