<script>
// --- –∏–º–∏—Ç–∞—Ü–∏—è Excel-–¥–∞–Ω–Ω—ã—Ö (—Ä–µ–∞–ª—å–Ω–æ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å JSON —Å Make –∏–ª–∏ Google Sheets API) ---
let existingUsers = []; // —Å—é–¥–∞ –ø–æ–¥–≥—Ä—É–∑—è—Ç—Å—è —Å—Ç—Ä–æ–∫–∏ –∏–∑ Excel

async function loadExistingUsers() {
  try {
    const res = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-.../pub?output=csv'); // –∏–ª–∏ —Å–≤–æ–π JSON webhook
    const text = await res.text();
    existingUsers = text.split('\n').slice(1).map(line => {
      const [fullName, email, phone, birthDate, country, timezone, chat_id] = line.split(',');
      return { fullName: fullName?.trim(), birthDate: birthDate?.trim(), chat_id: chat_id?.trim() };
    });
  } catch (e) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞:', e);
  }
}

loadExistingUsers();

// --- —Ç–≤–æ–π –∫–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ä–º—ã ---
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  formMessage.textContent = '';
  formMessage.className = 'message';

  if (!document.getElementById('consentCheck').checked) {
    formMessage.textContent = translations.ru.fill_all;
    formMessage.classList.add('error');
    return;
  }

  const data = {
    fullName: form.fullName.value.trim(),
    email: form.email.value.trim(),
    phone: form.phone.value.trim(),
    birthDate: form.birthDate.value.trim(),
    country: countryHidden.value,
    timezone: timezoneHidden.value,
    chat_id: chatIdField.value
  };

  if (!data.fullName || !data.email || !data.phone || !data.birthDate || !data.country) {
    formMessage.textContent = translations.ru.fill_all;
    formMessage.classList.add('error');
    return;
  }

  // üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Å–ø–∏—Å–∫–µ
  const found = existingUsers.find(u => 
    u.fullName.toLowerCase() === data.fullName.toLowerCase() && 
    u.birthDate === data.birthDate
  );

  if (found) {
    if (found.chat_id) {
      formMessage.textContent = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.";
      formMessage.classList.add('error');
      return;
    } else {
      if (confirm("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ —É–∂–µ –µ—Å—Ç—å, –Ω–æ –±–µ–∑ chat_id. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å chat_id –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.")) {
        // –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –µ–≥–æ chat_id —á–µ—Ä–µ–∑ —Ç–æ—Ç –∂–µ webhook
        await fetch('https://hook.eu2.make.com/1unspxkdfik4bgnhsvpra9m71urdffcj', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });
        formMessage.textContent = "chat_id –¥–æ–±–∞–≤–ª–µ–Ω, –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚úÖ";
        formMessage.classList.add('success');
        return;
      } else {
        formMessage.textContent = "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.";
        formMessage.classList.add('error');
        return;
      }
    }
  }

  // üÜï –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –æ–±—ã—á–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  try {
    const response = await fetch('https://hook.eu2.make.com/1unspxkdfik4bgnhsvpra9m71urdffcj', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });

    if (response.ok) {
      formMessage.textContent = translations.ru.success;
      formMessage.classList.add('success');
      form.reset();
    } else {
      formMessage.textContent = `–û—à–∏–±–∫–∞: ${response.status}`;
      formMessage.classList.add('error');
    }
  } catch (err) {
    formMessage.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.';
    formMessage.classList.add('error');
  }
});
</script>
